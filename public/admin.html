<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <title>Ibodulla.official ‚Äî Admin / Parent / Student</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* ===========================
       GLOBAL RESET & LAYOUT
       =========================== */
    :root{
      --green:#2e7d32;
      --dark:#233;
      --muted:#666;
      --bg:#f5f6fa;
      --card:#ffffff;
      --accent:#1b5e20;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--dark);}
    a{color:inherit;text-decoration:none}
    button{font-family:inherit}
    .app-shell{display:flex;min-height:100vh;align-items:stretch;}

    /* ===========================
       SIDEBAR
       =========================== */
    .sidebar{
      width:240px;background:var(--card);padding:18px;border-right:1px solid rgba(0,0,0,0.04);
      position:fixed;left:0;top:0;bottom:0;overflow:auto;box-shadow:2px 0 8px rgba(0,0,0,0.04);transition:transform .28s ease;
      z-index:1200;
    }
    .sidebar h2{text-align:center;color:var(--green);margin:2px 0 14px;font-size:18px}
    .group-list a, .main-menu a{display:block;padding:10px 12px;border-radius:8px;margin:6px 0;color:#333;cursor:pointer}
    .group-list a:hover,.main-menu a:hover{background:var(--green);color:white}
    .group-list a.active{background:var(--green);color:white}
    .sidebar .small{font-size:13px;color:var(--muted);margin-top:6px;text-align:center}

    /* ===========================
       MAIN CONTENT
       =========================== */
    .main{
      margin-left:240px;flex:1;padding:18px 20px 120px;transition:margin-left .28s ease;
    }
    header.top{
      display:flex;align-items:center;justify-content:space-between;background:var(--card);padding:12px 16px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.06)
    }
    header .left{display:flex;align-items:center;gap:12px}
    .hamburger{display:none;font-size:20px;background:none;border:0;color:var(--green);cursor:pointer}
    header h1{margin:0;color:var(--green);font-size:18px}
    header .user{font-size:14px;color:#333;display:flex;flex-direction:column;align-items:flex-end}
    header .user .name{font-weight:600}
    header .user button{margin-top:6px;background:#c62828;color:white;border:0;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:13px}

    /* cards/grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px;margin:18px 0}
    .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.04)}
    .card h3{margin:0 0 10px;color:#333;font-size:15px}
    .highlight{font-size:20px;font-weight:700;color:var(--green)}

    /* table */
    table{width:100%;border-collapse:collapse;background:var(--card);border-radius:10px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,0.04)}
    th,td{padding:10px;text-align:left;border-bottom:1px solid #f0f0f0}
    th{background:#fafafa;color:var(--muted);font-weight:600}
    td.center{text-align:center}
    .btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer}
    .btn-primary{background:var(--green);color:white}
    .btn-danger{background:#c62828;color:white}
    .choice{display:inline-block;padding:6px 10px;border-radius:20px;border:1px solid #e0e0e0;background:#f7f7f7;cursor:pointer}
    .choice.active{background:var(--green);color:white;border-color:var(--green)}

    /* inputs */
    input[type="text"],input[type="number"],input[type="password"],select{
      width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin:6px 0;box-sizing:border-box;
    }
    .row{display:flex;gap:10px;align-items:center}
    .col{flex:1}

    /* footer marquee */
    .footer-marquee{position:fixed;left:0;right:0;bottom:0;background:var(--accent);color:white;padding:10px;text-align:left;font-weight:600;z-index:1100}

    /* responsive */
    @media(max-width:900px){
      .sidebar{transform:translateX(-100%)} /* hidden by default */
      .sidebar.open{transform:translateX(0)}
      .main{margin-left:0}
      .hamburger{display:inline-block}
    }
    /* small tweaks */
    .muted{color:var(--muted);font-size:13px}
    .tiny{font-size:12px;color:#888}

  </style>
</head>
<body>
  <div class="app-shell">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" aria-label="left sidebar">
      <h2>Ibodulla.official</h2>

      <div class="main-menu">
        <a id="navAdmin">‚öôÔ∏è Admin</a>
        <a id="navStudent">üë©‚Äçüéì Student</a>
        <a id="navParent">üë™ Parent</a>
        <a id="navTokens">üîê Tokens</a>
      </div>

      <hr style="border:none;height:8px">

      <div class="muted" style="text-align:center">Guruhlar</div>
      <div class="group-list" id="groupList"></div>

      <div class="sidebar-footer small">
        <div style="margin-top:12px">¬© Ibodulla.official</div>
      </div>
    </aside>

    <!-- Main content -->
    <main class="main" id="main">
      <header class="top">
        <div class="left">
          <button class="hamburger" id="hamburgerBtn" aria-label="menu">&#9776;</button>
          <h1 id="pageTitle">Admin ‚Äî Guruh 1</h1>
        </div>
        <div class="user" id="userBox">
          <div class="name" id="userName">Ishchi</div>
          <div class="tiny" id="userSub">education_of_ibodulla</div>
          <button id="logoutBtn" style="display:none">Chiqish</button>
        </div>
      </header>

      <div id="pageContent">
        <!-- Dynamic content injected here -->
      </div>
    </main>
  </div>

  <div class="footer-marquee">
    <i class="fab fa-instagram" style="color:#e1306c;margin-right:8px"></i> education_of_ibodulla ‚ú®
  </div>

<script>
/* =========================================================================
   Single-file app: Admin / Student / Parent + Tokens
   - Data stored in localStorage under 'eoib_students' and 'eoib_coins'
   - Works offline (localStorage). For global sync use Firebase later.
   ========================================================================= */

/* ========== Seed data (will initialize only if none exists) ========== */
const seedStudents = [
  { id: "s0", name: "Humoyun Abdumominov", phone:"+998901112200", token:"token0", group:0, points:217, homework:90, davomat:true, odob:true, faollik:false },
  { id: "s1", name: "Abdulatif Anorov", phone:"+998901112201", token:"token1", group:0, points:77, homework:100, davomat:true, odob:true, faollik:true },
  { id: "s2", name: "Bahodir Izatullayev", phone:"+998901112202", token:"token2", group:0, points:75, homework:80, davomat:false, odob:true, faollik:true },
  { id: "s3", name: "Sino Raximov", phone:"+998901112203", token:"token3", group:0, points:62, homework:95, davomat:true, odob:false, faollik:true },
  { id: "s4", name: "Javdat Ziyayev", phone:"+998901112204", token:"token4", group:0, points:62, homework:85, davomat:true, odob:true, faollik:true },
  // group 2
  { id: "s5", name: "Samar Axadjanov", phone:"+998901112205", token:"token5", group:1, points:60, homework:75, davomat:true, odob:true, faollik:false },
  { id: "s6", name: "Akbarjon Shoyunusov", phone:"+998901112206", token:"token6", group:1, points:59, homework:66, davomat:true, odob:true, faollik:true },
  { id: "s7", name: "Shaxriyor Sattarov", phone:"+998901112207", token:"token7", group:1, points:19, homework:70, davomat:true, odob:true, faollik:false },
  { id: "s8", name: "Jasur Abdullayev", phone:"+998901112208", token:"token8", group:1, points:50, homework:60, davomat:true, odob:true, faollik:true },
  { id: "s9", name: "Azizbek Rustamov", phone:"+998901112209", token:"token9", group:1, points:45, homework:80, davomat:false, odob:true, faollik:false },
  // group 3
  { id: "s10", name: "Anvar Rahimov", phone:"+998901112210", token:"token10", group:2, points:40, homework:88, davomat:true, odob:true, faollik:true },
  { id: "s11", name: "Shahzod Tursunov", phone:"+998901112211", token:"token11", group:2, points:35, homework:92, davomat:true, odob:false, faollik:true },
  { id: "s12", name: "Oydin Ismoilov", phone:"+998901112212", token:"token12", group:2, points:30, homework:60, davomat:false, odob:true, faollik:false },
  { id: "s13", name: "Bekzod Karimov", phone:"+998901112213", token:"token13", group:2, points:20, homework:50, davomat:true, odob:true, faollik:true },
  { id: "s14", name: "Diyorbek Salimov", phone:"+998901112214", token:"token14", group:2, points:10, homework:45, davomat:true, odob:false, faollik:false },
  // group 4
  { id: "s15", name: "Jamshid Nurmatov", phone:"+998901112215", token:"token15", group:3, points:5, homework:80, davomat:true, odob:true, faollik:true },
  { id: "s16", name: "Mardonbek Rustamov", phone:"+998901112216", token:"token16", group:3, points:6, homework:30, davomat:true, odob:true, faollik:false },
  { id: "s17", name: "Azamat Toirov", phone:"+998901112217", token:"token17", group:3, points:7, homework:70, davomat:false, odob:true, faollik:true },
  { id: "s18", name: "Farruxbek Akbarov", phone:"+998901112218", token:"token18", group:3, points:8, homework:77, davomat:true, odob:true, faollik:true },
  { id: "s19", name: "Ibrohim Shokirov", phone:"+998901112219", token:"token19", group:3, points:9, homework:55, davomat:true, odob:false, faollik:false }
];

const groups = [
  { id:0, name:"1-guruh", time:"08:00-10:00" },
  { id:1, name:"2-guruh", time:"10:00-12:00" },
  { id:2, name:"3-guruh", time:"14:00-16:00" },
  { id:3, name:"4-guruh", time:"16:00-18:00" }
];

/* ========== STORAGE HELPERS ========== */
function getStudents(){
  try{
    const raw = localStorage.getItem('eoib_students');
    if(!raw){ localStorage.setItem('eoib_students', JSON.stringify(seedStudents)); return JSON.parse(JSON.stringify(seedStudents)); }
    return JSON.parse(raw);
  }catch(e){ console.error(e); localStorage.removeItem('eoib_students'); return JSON.parse(JSON.stringify(seedStudents)); }
}
function setStudents(arr){
  localStorage.setItem('eoib_students', JSON.stringify(arr));
  // trigger storage event in same tab too:
  window.dispatchEvent(new Event('storage'));
}
function getCoinMap(){
  try{
    const raw = localStorage.getItem('eoib_coins');
    return raw ? JSON.parse(raw) : {};
  }catch(e){ localStorage.removeItem('eoib_coins'); return {}; }
}
function setCoinMap(obj){
  localStorage.setItem('eoib_coins', JSON.stringify(obj));
  window.dispatchEvent(new Event('storage'));
}

/* ========== INITIAL DATA LOAD ========== */
let students = getStudents();
let coinMap = getCoinMap();

/* ========== UI ELEMENTS ========== */
const pageContent = document.getElementById('pageContent');
const pageTitle = document.getElementById('pageTitle');
const groupListEl = document.getElementById('groupList');
const sidebarEl = document.getElementById('sidebar');
const hamburgerBtn = document.getElementById('hamburgerBtn');
const userNameEl = document.getElementById('userName');
const logoutBtn = document.getElementById('logoutBtn');

/* ========== ROUTING (simple hash-based) ========== */
function navigateTo(route){
  // route: 'admin', 'student', 'parent', 'tokens'
  document.querySelectorAll('.main-menu a').forEach(a=>a.classList.remove('active'));
  document.getElementById('navAdmin').classList.remove('active');
  document.getElementById('navStudent').classList.remove('active');
  document.getElementById('navParent').classList.remove('active');
  document.getElementById('navTokens').classList.remove('active');

  if(route==='admin'){ document.getElementById('navAdmin').classList.add('active'); renderAdmin(); }
  else if(route==='student'){ document.getElementById('navStudent').classList.add('active'); renderStudentLogin(); }
  else if(route==='parent'){ document.getElementById('navParent').classList.add('active'); renderParentLogin(); }
  else if(route==='tokens'){ document.getElementById('navTokens').classList.add('active'); renderTokens(); }
  else { navigateTo('admin'); }
}

/* ========== SIDEBAR GROUP RENDER ========== */
function renderGroupList(){
  groupListEl.innerHTML = '';
  groups.forEach(g=>{
    const a = document.createElement('a');
    a.textContent = `${g.name} (${g.time})`;
    a.dataset.group = g.id;
    a.className = 'group-item';
    a.onclick = ()=>{ renderAdmin(g.id); pageTitle.innerText = `${g.name} ‚Äî Admin`; closeSidebarOnMobile(); };
    groupListEl.appendChild(a);
  });
}
renderGroupList();

/* ========== COMMON UTILITIES ========== */
function closeSidebarOnMobile(){
  if(window.innerWidth <= 900) sidebarEl.classList.remove('open');
}

/* show toast */
function toast(msg, time=2200){
  const el=document.createElement('div');
  el.textContent = msg;
  el.style.position='fixed';
  el.style.right='16px';
  el.style.bottom='80px';
  el.style.background='rgba(0,0,0,0.8)';
  el.style.color='white';
  el.style.padding='10px 14px';
  el.style.borderRadius='8px';
  el.style.zIndex=9999;
  document.body.appendChild(el);
  setTimeout(()=>el.style.opacity='0', time-300);
  setTimeout(()=>el.remove(), time);
}

/* ========== ADMIN PAGE ========== */
function renderAdmin(groupId = 0){
  pageTitle.innerText = `${groups[groupId].name} ‚Äî Admin`;
  // highlight group in group list
  document.querySelectorAll('.group-list a').forEach(a=>a.classList.remove('active'));
  const groupNodes = document.querySelectorAll('.group-list a');
  if(groupNodes[groupId]) groupNodes[groupId].classList.add('active');

  // build HTML
  let html = '';
  html += `<div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">`;
  html += `<div style="flex:1;min-width:240px" class="card">
            <h3>Guruh: ${groups[groupId].name} <span class="tiny">(${groups[groupId].time})</span></h3>
            <p class="muted">Bu panel orqali davomat, coin, faollik va uyga vazifalarni boshqarishingiz mumkin.</p>
            <div style="margin-top:8px">
              <label class="tiny">Qidirish (ism bo'yicha)</label>
              <input type="text" id="adminSearch" placeholder="Ism yoki familiya qidirish..."/>
            </div>
          </div>`;

  html += `<div style="min-width:260px" class="card">
            <h3>Omonat (tokenlar)</h3>
            <p class="muted">Token yaratish va nusxa olish</p>
            <div style="display:flex;gap:8px">
              <input id="newStudentName" placeholder="Ism Familiya"/>
              <button class="btn btn-primary" id="createStudentBtn">+ Qo'sh</button>
            </div>
          </div>`;

  html += `</div>`;

  // Students table for the group
  const groupStudents = students.filter(s=>s.group === groupId);
  html += `<div style="margin-top:14px" class="card">
            <h3>O'quvchilar ro'yxati (${groupStudents.length})</h3>
            <table>
              <thead><tr><th>#</th><th>Ism Familiya</th><th>Coins</th><th>Davomat</th><th>Odob</th><th>Faollik</th><th>Uyga</th><th>Amal</th></tr></thead>
              <tbody id="adminStudentsTbody">`;
  groupStudents.forEach((s,idx)=>{
    const key = s.id;
    const coins = coinMap[key] || 0;
    html += `<tr id="row-${key}">
      <td>${idx+1}</td>
      <td>${s.name}<div class="tiny">${s.phone} ‚Ä¢ token:${s.token}</div></td>
      <td class="center"><strong id="coins-${key}">${coins}</strong> üí∞</td>
      <td class="center">
        <span data-action="davomat" data-id="${key}" class="choice ${s.davomat? 'active':''}">${s.davomat? '‚úî':'‚ùå'}</span>
      </td>
      <td class="center">
        <span data-action="odob" data-id="${key}" class="choice ${s.odob? 'active':''}">${s.odob? '‚úî':'‚ùå'}</span>
      </td>
      <td class="center">
        <span data-action="faollik" data-id="${key}" class="choice ${s.faollik? 'active':''}">${s.faollik? '‚úî':'‚ùå'}</span>
      </td>
      <td class="center"><input type="number" id="homework-${key}" value="${s.homework}" style="width:80px;padding:6px;border-radius:6px"/></td>
      <td class="center">
        <input type="number" id="addCoin-${key}" placeholder="soni" style="width:90px;padding:6px;border-radius:6px"/>
        <div style="margin-top:6px;display:flex;gap:6px;justify-content:center">
          <button class="btn btn-primary" data-do="add" data-id="${key}">+ Add</button>
          <button class="btn btn-danger" data-do="remove" data-id="${key}">- Remove</button>
        </div>
      </td>
    </tr>`;
  });
  html += `</tbody></table></div>`;

  pageContent.innerHTML = html;

  // attach handlers
  document.getElementById('createStudentBtn').onclick = ()=>{
    const name = document.getElementById('newStudentName').value.trim();
    if(!name){ toast('Ism kiriting'); return; }
    createNewStudent(name, groupId);
    document.getElementById('newStudentName').value='';
    renderAdmin(groupId);
    toast('Yangi o‚Äòquvchi yaratildi');
  };

  document.querySelectorAll('#adminStudentsTbody button[data-do]').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.id;
      const op = btn.dataset.do;
      const inEl = document.getElementById(`addCoin-${id}`);
      const val = parseInt(inEl.value);
      if(!val || val<=0){ toast('Iltimos son kiriting'); return; }
      changeCoins(id, op==='add'? val : -val);
      inEl.value='';
    };
  });

  // choices toggles
  document.querySelectorAll('#adminStudentsTbody .choice').forEach(ch=>{
    ch.onclick = ()=>{
      const id = ch.dataset.id;
      const action = ch.dataset.action;
      toggleStudentField(id, action);
      // reflect on UI
      ch.classList.toggle('active');
      ch.textContent = ch.classList.contains('active') ? '‚úî' : '‚ùå';
    };
  });

  // homework update on blur
  groupStudents.forEach(s=>{
    const el = document.getElementById(`homework-${s.id}`);
    el.onchange = ()=> {
      const val = parseInt(el.value) || 0;
      updateStudentField(s.id, 'homework', val);
      toast('Uyga vazifa yangilandi');
    };
  });

  // search
  document.getElementById('adminSearch').addEventListener('input', (e)=>{
    const q = e.target.value.toLowerCase().trim();
    document.querySelectorAll('#adminStudentsTbody tr').forEach(tr=>{
      const txt = tr.innerText.toLowerCase();
      tr.style.display = txt.includes(q) ? '' : 'none';
    });
  });
}

/* ========== CREATE NEW STUDENT (admin) ========== */
function createNewStudent(name, groupId){
  // generate id and token
  const id = 's'+(Math.floor(Math.random()*90000)+Date.now()%1000);
  const token = 't'+Math.random().toString(36).slice(2,9);
  const phone = '+9989' + (Math.floor(1000000 + Math.random()*8999999)).toString(); // dummy
  const newS = { id, name, phone, token, group:groupId, points:0, homework:0, davomat:true, odob:true, faollik:false };
  students.push(newS);
  setStudents(students);
  // init coin
  coinMap[id] = 0;
  setCoinMap(coinMap);
}

/* ========== COIN CHANGE (admin) ========== */
function changeCoins(studentId, delta){
  coinMap = getCoinMap();
  const prev = coinMap[studentId] || 0;
  const next = Math.max(0, prev + delta);
  coinMap[studentId] = next;
  setCoinMap(coinMap);
  // update DOM if present
  const el = document.getElementById('coins-'+studentId);
  if(el) el.textContent = next;
  toast(`Coins yangilandi: ${next}`);
}

/* ========== toggle student boolean fields (davomat, odob, faollik) ========== */
function toggleStudentField(id, field){
  const idx = students.findIndex(s=>s.id===id);
  if(idx===-1) return;
  students[idx][field] = !students[idx][field];
  setStudents(students);
}

/* ========== update student field (homework etc) ========== */
function updateStudentField(id, field, value){
  const idx = students.findIndex(s=>s.id===id);
  if(idx===-1) return;
  students[idx][field] = value;
  setStudents(students);
}

/* ========== PARENT (token) PAGE ========== */
function renderParentLogin(){
  pageTitle.innerText = 'Parent ‚Äî Token kirish';
  pageContent.innerHTML = `
    <div class="card" style="max-width:680px;margin-top:14px">
      <h3>Ota-ona: Token orqali kirish</h3>
      <p class="muted">Sizga berilgan tokenni kiriting (sms yoki telegram orqali yuborilgan).</p>
      <div style="display:flex;gap:10px;margin-top:10px">
        <input id="parentToken" placeholder="tokenni kiriting (masalan token0)" />
        <button class="btn btn-primary" id="parentEnter">Kirish</button>
      </div>
      <div id="parentError" class="tiny" style="color:#c62828;margin-top:8px"></div>
    </div>
  `;
  document.getElementById('parentEnter').onclick = ()=>{
    const t = document.getElementById('parentToken').value.trim();
    if(!t){ document.getElementById('parentError').innerText = 'Token kiriting'; return; }
    const found = students.find(s=>s.token === t);
    if(!found){ document.getElementById('parentError').innerText = 'Token topilmadi'; return; }
    renderParent(found.id);
  };
}

/* render parent view for a student id */
function renderParent(studentId){
  const s = students.find(x=>x.id===studentId);
  if(!s) { renderParentLogin(); return; }
  pageTitle.innerText = `Parent ‚Äî ${s.name}`;
  // ensure coin map present
  coinMap = getCoinMap();
  pageContent.innerHTML = `
    <div style="max-width:900px">
      <div class="card">
        <h3>${s.name}</h3>
        <div class="tiny">${s.phone} ‚Ä¢ token: ${s.token}</div>
        <div style="display:flex;gap:12px;margin-top:10px">
          <div style="flex:1">
            <p class="muted">üìã Davomat</p>
            <div><span class="choice ${s.davomat? 'active':''}">${s.davomat? '‚úî':'‚ùå'}</span></div>
          </div>
          <div style="width:160px">
            <p class="muted">üí∞ Coins</p>
            <div><span id="parent-coins" class="highlight">${coinMap[studentId]||0}</span> üí∞</div>
          </div>
          <div style="width:160px">
            <p class="muted">üèÖ Points</p>
            <div><span class="highlight">${s.points}</span> ‚ö°</div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>‚≠ê Odob-axloq & Faollik</h3>
        <div style="display:flex;gap:10px;align-items:center">
          <div><span class="choice ${s.odob? 'active':''}">Odob ‚úî</span></div>
          <div><span class="choice ${!s.odob? 'active':''}">Odob ‚ùå</span></div>
          <div style="width:16px"></div>
          <div><span class="choice ${s.faollik? 'active':''}">Faollik ‚úî</span></div>
          <div><span class="choice ${!s.faollik? 'active':''}">Faollik ‚ùå</span></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>üìò Uyga vazifalar</h3>
        <div style="display:flex;gap:10px;align-items:center">
          <div class="muted">Progress:</div>
          <div style="flex:1;background:#f0f0f0;border-radius:8px;padding:6px">
            <div id="parent-homework" style="width:60%;background:var(--green);color:white;padding:6px;border-radius:6px;text-align:center">${s.homework}%</div>
          </div>
          <div class="tiny">${s.homework}%</div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
        <button class="btn" id="parentBack">Orqaga</button>
        <button class="btn btn-primary" id="parentRefresh">Yangilash</button>
      </div>
    </div>
  `;
  document.getElementById('parentBack').onclick = ()=> renderParentLogin();
  document.getElementById('parentRefresh').onclick = ()=> updateParentView(studentId);

  // start polling for coin changes
  startParentPolling(studentId);
}

/* update parent view coin from storage */
function updateParentView(studentId){
  coinMap = getCoinMap();
  const el = document.getElementById('parent-coins');
  if(el) el.textContent = coinMap[studentId] || 0;
  // update homework from students data (in case changed)
  const s = students.find(x=>x.id===studentId);
  const hwEl = document.getElementById('parent-homework');
  if(hwEl) hwEl.textContent = `${s.homework}%`;
}

/* start polling and storage event to reflect updates quickly */
let parentPollingInterval = null;
function startParentPolling(studentId){
  // clear existing
  if(parentPollingInterval) clearInterval(parentPollingInterval);
  // update immediately
  updateParentView(studentId);
  parentPollingInterval = setInterval(()=>updateParentView(studentId), 2000);
}

/* listen storage event to sync across tabs */
window.addEventListener('storage', ()=>{
  // reload in-memory copies
  students = getStudents();
  coinMap = getCoinMap();
  // if current page is parent, refresh shown values:
  const title = pageTitle.innerText || '';
  if(title.startsWith('Parent ‚Äî ')){
    const tokenOrName = title.replace('Parent ‚Äî ', '').trim();
    const s = students.find(x=>x.name === tokenOrName || x.token === tokenOrName);
    if(s) updateParentView(s.id);
  }
  // if admin table visible, refresh coin cells
  document.querySelectorAll('[id^="coins-"]').forEach(el=>{
    const id = el.id.replace('coins-','');
    el.textContent = coinMap[id] || 0;
  });
});

/* ========== STUDENT (login) PAGE ========== */
function renderStudentLogin(){
  pageTitle.innerText = 'Student ‚Äî Kirish';
  pageContent.innerHTML = `
    <div style="max-width:640px" class="card">
      <h3>Student login</h3>
      <p class="muted">Telefon va parol bilan kirish</p>
      <div style="display:flex;gap:8px">
        <div style="min-width:68px">
          <div class="tiny">+998</div>
        </div>
        <div style="flex:1"><input id="stuPhone" placeholder="901112233" maxlength="9"/></div>
      </div>
      <div style="margin-top:8px">
        <input id="stuPass" type="password" placeholder="Parol"/>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn-primary" id="stuLogin">Kirish</button>
        <button class="btn" id="stuBack">Orqaga</button>
      </div>
      <div id="stuError" class="tiny" style="color:#c62828;margin-top:8px"></div>
    </div>
  `;
  document.getElementById('stuLogin').onclick = ()=>{
    const phone = '+998' + document.getElementById('stuPhone').value.trim();
    const pass = document.getElementById('stuPass').value.trim();
    // Demo auth: password = '12345' for any student with matching phone
    const found = students.find(s=>s.phone === phone);
    if(!found){ document.getElementById('stuError').innerText = 'Foydalanuvchi topilmadi'; return; }
    if(pass !== '12345'){ document.getElementById('stuError').innerText = 'Parol noto‚Äòg‚Äòri'; return; }
    // success
    renderStudentDashboard(found.id);
  };
  document.getElementById('stuBack').onclick = ()=> navigateTo('admin');
}

/* student dashboard */
function renderStudentDashboard(studentId){
  const s = students.find(x=>x.id===studentId);
  if(!s) return renderStudentLogin();
  pageTitle.innerText = `Student ‚Äî ${s.name}`;
  // ensure coin map loaded
  coinMap = getCoinMap();
  pageContent.innerHTML = `
    <div style="max-width:900px">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3>${s.name}</h3>
            <div class="tiny">${s.phone} ‚Ä¢ token: ${s.token}</div>
          </div>
          <div style="text-align:right">
            <div class="muted">Coins</div>
            <div class="highlight" id="stu-coins">${coinMap[studentId] || 0}</div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Uyga vazifalar</h3>
        <div style="display:flex;align-items:center;gap:10px">
          <div style="flex:1;background:#f0f0f0;padding:6px;border-radius:8px">
            <div id="stu-progress-bar" style="width:${s.homework}%;background:var(--green);color:#fff;padding:6px;border-radius:6px;text-align:center">${s.homework}%</div>
          </div>
          <div class="tiny">${s.homework}%</div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px">
        <button class="btn" id="stuLogout">Chiqish</button>
        <button class="btn btn-primary" id="stuRefresh">Yangilash</button>
      </div>
    </div>
  `;
  document.getElementById('stuLogout').onclick = ()=> renderStudentLogin();
  document.getElementById('stuRefresh').onclick = ()=> updateStudentView(studentId);
  startStudentPolling(studentId);
}

/* update student view */
let studentPollingInterval=null;
function updateStudentView(studentId){
  coinMap = getCoinMap();
  const el = document.getElementById('stu-coins');
  if(el) el.textContent = coinMap[studentId] || 0;
  // update homework
  const s = students.find(x=>x.id===studentId);
  const bar = document.getElementById('stu-progress-bar');
  if(bar) bar.style.width = (s.homework || 0) + '%';
  if(bar) bar.textContent = (s.homework || 0) + '%';
}

/* polling */
function startStudentPolling(studentId){
  if(studentPollingInterval) clearInterval(studentPollingInterval);
  updateStudentView(studentId);
  studentPollingInterval = setInterval(()=>updateStudentView(studentId), 2000);
}

/* ========== TOKENS PAGE ========== */
function renderTokens(){
  pageTitle.innerText = 'Admin ‚Äî Tokens';
  pageContent.innerHTML = `
    <div class="card" style="max-width:900px">
      <h3>Farzand tokenlari</h3>
      <p class="muted">Har bir farzand uchun token va oson kirish linklarini nusxa ko'chiring.</p>
      <table>
        <thead><tr><th>#</th><th>Ism</th><th>Token</th><th>Link</th><th>Amal</th></tr></thead>
        <tbody id="tokensTbody"></tbody>
      </table>
    </div>
  `;
  const tbody = document.getElementById('tokensTbody');
  tbody.innerHTML = '';
  students.forEach((s,i)=>{
    const link = `${location.origin}${location.pathname}#parent?token=${encodeURIComponent(s.token)}`;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${s.name}</td><td>${s.token}</td>
      <td style="max-width:320px"><a href="${link}" target="_blank">${link}</a></td>
      <td><button class="btn" data-copy="${link}">Copy</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button[data-copy]').forEach(b=>{
    b.onclick = ()=>{ navigator.clipboard.writeText(b.dataset.copy).then(()=>toast('Link nusxalandi')); };
  });
}

/* ========== NAV HANDLERS ========= */
document.getElementById('navAdmin').onclick = ()=> navigateTo('admin');
document.getElementById('navStudent').onclick = ()=> navigateTo('student');
document.getElementById('navParent').onclick = ()=> navigateTo('parent');
document.getElementById('navTokens').onclick = ()=> navigateTo('tokens');

hamburgerBtn.onclick = ()=> sidebarEl.classList.toggle('open');

function sidebarToggleForInitial(){
  // show sidebar on large screens; hidden on small
  if(window.innerWidth <= 900) sidebarEl.classList.remove('open');
  else sidebarEl.classList.add('open');
}
sidebarToggleForInitial();
window.addEventListener('resize', sidebarToggleForInitial);

/* ========== STORAGE SYNC INIT ========== */
function initStorageIfMissing(){
  // ensure coins map has keys for existing students
  students = getStudents();
  coinMap = getCoinMap();
  let changed=false;
  students.forEach(s=>{
    if(!(s.id in coinMap)){ coinMap[s.id] = coinMap[s.id] || 0; changed=true; }
  });
  if(changed) setCoinMap(coinMap);
}
initStorageIfMissing();

/* ========== LISTEN to manual 'storage' event we dispatch above =======*/
window.addEventListener('storage', ()=>{
  // refresh in-memory arrays
  students = getStudents();
  coinMap = getCoinMap();
  // update admin view coins if visible
  document.querySelectorAll('[id^="coins-"]').forEach(el=>{
    const id = el.id.replace('coins-','');
    el.textContent = coinMap[id] || 0;
  });
  // if tokens page open, rerender
  if(document.getElementById('tokensTbody')) renderTokens();
});

/* ========== INITIAL NAV (check hash) ========== */
function parseHash(){
  const h = location.hash || '';
  if(h.startsWith('#admin')) return 'admin';
  if(h.startsWith('#student')) return 'student';
  if(h.startsWith('#parent')) {
    // if token param present, auto-open student
    const parts = h.split('?');
    if(parts[1]){
      const params = new URLSearchParams(parts[1]);
      const token = params.get('token');
      if(token){
        const s = students.find(x=>x.token === token);
        if(s){ renderParent(s.id); return 'parent'; }
      }
    }
    return 'parent';
  }
  if(h.startsWith('#tokens')) return 'tokens';
  return 'admin';
}
navigateTo(parseHash());

/* ========== Finished ========= */
console.log('App loaded ‚Äî students:', students.length);
</script>
</body>
</html>
